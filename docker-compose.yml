version: '3.7'

services:

#  ______                     _   _             
# |  ____|                   | | (_)            
# | |__  __  _____  ___ _   _| |_ _  ___  _ __  
# |  __| \ \/ / _ \/ __| | | | __| |/ _ \| '_ \ 
# | |____ >  <  __/ (__| |_| | |_| | (_) | | | |
# |______/_/\_\___|\___|\__,_|\__|_|\___/|_| |_|
#

  nethermind:
    image: nethermind/nethermind:${NETHERMIND_VERSION:-}
    restart: unless-stopped
    init: true
    networks: [ cluster ]
    ports:
      - "127.0.0.1:8545:8545"    # JSON-RPC port
      - "127.0.0.1:8645:8645"    # Prometheus metrics port
      - "30303:30303"  # P2P port 
    environment:
      - DOTNET_BUNDLE_EXTRACT_BASE_DIR=/var/lib/nethermind
    command: >-
      --config=${NETWORK:-} 
      --datadir=/var/lib/nethermind 
      --JsonRpc.JwtSecretFile=/var/lib/jwtsecret/jwt.hex 
      --Sync.SnapSync=true 
      --JsonRpc.Enabled=true 
      --JsonRpc.Host=0.0.0.0 
      --JsonRpc.Port=8545
      --JsonRpc.EnginePort=8551
      --JsonRpc.EngineHost=0.0.0.0
      --HealthChecks.Enabled=true 
      --Metrics.Enabled=true 
      --Metrics.PushGatewayUrl=http://localhost:9091/metrics
    volumes:
      - ${DATA_FOLDER:-./data}/.nethermind:/var/lib/nethermind
      - ./data/jwt:/var/lib/jwtsecret

  besu:
    image: hyperledger/besu:${BESU_VERSION:-}
    restart: unless-stopped
    init: true
    user: "${UID}:${GID}"
    networks: [ cluster ]
    ports:
      - "127.0.0.1:8545:8545"    # JSON-RPC port
      - "127.0.0.1:9545:9545"    # Prometheus metrics port
      - "30303:30303"  # P2P port 
    environment:
      - JAVA_OPTS=-Xmx6g
    command: >-
      --network=${NETWORK:-}
      --sync-mode=X_SNAP
      --data-path=/var/lib/besu
      --data-storage-format=BONSAI
      --engine-jwt-secret=/var/lib/jwtsecret/jwt.hex
      --Xplugin-rocksdb-high-spec-enabled
      --rpc-ws-enabled
      --rpc-ws-host=0.0.0.0
      --rpc-http-enabled=true
      --metrics-enabled=true
    volumes:
      - ${DATA_FOLDER:-./data}/.besu:/var/lib/besu
      - ./data/jwt:/var/lib/jwtsecret

#   _____                                         
#  / ____|                                        
# | |     ___  _ __  ___  ___ _ __  ___ _   _ ___ 
# | |    / _ \| '_ \/ __|/ _ \ '_ \/ __| | | / __|
# | |___| (_) | | | \__ \  __/ | | \__ \ |_| \__ \
#  \_____\___/|_| |_|___/\___|_| |_|___/\__,_|___/
#


  teku:
    image: consensys/teku:${TEKU_VERSION:-}
    restart: unless-stopped
    init: true
    networks: [ cluster ]
    user: "${UID}:${GID}"
    ports:
      - "127.0.0.1:8008:8008" # Prometheus metrics
      - "127.0.0.1:5051:5051" # Rest port
      - "9000:9000" # P2P port
    environment:
      - JAVA_OPTS=-Xmx6g
      - TEKU_OPTS=-XX:-HeapDumpOnOutOfMemoryError
    command: >-
      --network=${NETWORK:-}
      --data-path=/var/lib/teku_beacon
      --ee-endpoint=http://${EL_CLIENT:-nethermind}:8551
      --ee-jwt-secret-file=/var/lib/jwtsecret/jwt.hex
      --initial-state=${CHECKPOINT_SYNC_URL:-}
      --metrics-enabled=true
      --rest-api-enabled=true
      --rest-api-interface=0.0.0.0
      --builder-endpoint=http://mev-boost:18550
      --validators-builder-registration-default-enabled=true
      --p2p-nat-method=UPNP 
    volumes:
      - ${DATA_FOLDER:-./data}/.teku:/var/lib/teku_beacon
      - ./data/jwt:/var/lib/jwtsecret
  
  nimbus-trusted-sync:
    image: statusim/nimbus-eth2:${NIMBUS_VERSION:-}
    restart: unless-stopped
    init: true
    user: "${UID}:${GID}"
    networks: [ cluster ]
    command: >-
      --network=${NETWORK:-}
      trustedNodeSync
      --trusted-node-url="${CHECKPOINT_SYNC_URL:-}"
      --data-dir=/var/lib/nimbus_beacon
    volumes:
      - ${DATA_FOLDER:-./data}/.nimbus:/var/lib/nimbus_beacon
      - ./data/jwt:/var/lib/jwtsecret

  nimbus:
    image: statusim/nimbus-eth2:${NIMBUS_VERSION:-}
    restart: unless-stopped
    init: true
    user: "${UID}:${GID}"
    networks: [ cluster ]
    ports:
      - "127.0.0.1:8008:8008" # Prometheus metrics
      - "127.0.0.1:5052:5052" # Rest Port
      - "9000:9000" # P2P port
    command: >-
      --network=${NETWORK:-}
      --data-dir=/var/lib/nimbus_beacon
      --web3-url=http://${EL_CLIENT:-nethermind}:8551
      --jwt-secret=/var/lib/jwtsecret/jwt.hex
      --payload-builder=true
      --payload-builder-url=http://mev-boost:18550
      --rest
      --rest-address=0.0.0.0
      --rest-port=5052
      --metrics
      --metrics-port=8008 
    volumes:
      - ${DATA_FOLDER:-./data}/.nimbus:/var/lib/nimbus_beacon
      - ./data/jwt:/var/lib/jwtsecret
  
  lodestar:
    image: chainsafe/lodestar:${LODESTAR_VERSION:-}
    restart: unless-stopped
    init: true
    networks: [ cluster ]
    ports:
      - "127.0.0.1:8008:8008" # Prometheus metrics
      - "127.0.0.1:9596:9596" # Rest port
      - "9004:9004" # P2P port
    command: >-
      beacon
      --network=${NETWORK:-}
      --dataDir=/var/lib/lodestar_beacon
      --checkpointSyncUrl=${CHECKPOINT_SYNC_URL:-}
      --execution.urls="http://${EL_CLIENT:-nethermind}:8551"
      --builder
      --builder.urls=http://mev-boost:18550
      --network.connectToDiscv5Bootnodes
      --suggestedFeeRecipient=${FEE_RECIPIENT:-}
      --jwt-secret="/var/lib/jwtsecret/jwt.hex"
      --logFile=/root/.local/share/lodestar/lodestar.log
      --metrics=true
      --metrics.address=0.0.0.0
      --rest.address=0.0.0.0
      --port=9004
      --listenAddress=0.0.0.0
    volumes:
      - ${DATA_FOLDER:-./data}/.lodestar:/var/lib/lodestar_beacon
      - ./data/jwt:/var/lib/jwtsecret
  
  mev-boost:
    image: flashbots/mev-boost:${MEV_BOOST_VERSION:-}
    restart: unless-stopped
    init: true
    networks: [ cluster ]
    command: >-
      -${NETWORK:-}
      -addr="0.0.0.0:18550"
      -min-bid 0.05
      -relay-check
      -relay ${RELAY1:-}
      -relay ${RELAY2:-}
      -relay ${RELAY3:-}
    volumes:
      - ${DATA_FOLDER:-./data}/.mev-boost:/root/.local/share/lodestar

#   __  __             _ _             _             
#  |  \/  |           (_) |           (_)            
#  | \  / | ___  _ __  _| |_ ___  _ __ _ _ __   __ _ 
#  | |\/| |/ _ \| '_ \| | __/ _ \| '__| | '_ \ / _` |
#  | |  | | (_) | | | | | || (_) | |  | | | | | (_| |
#  |_|  |_|\___/|_| |_|_|\__\___/|_|  |_|_| |_|\__, |
#                                               __/ |
#                                              |___/ 

  node-exporter:
    image: prom/node-exporter:latest
    network_mode: host
    command: >-
      --path.rootfs=/host
      --web.listen-address=localhost:9100

    pid: host
    restart: unless-stopped
    volumes:
      - '/:/host:ro,rslave'
  
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    networks: [ cluster ]
    ports:
      - "127.0.0.1:8090:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
  
  prometheus:
    image: prom/prometheus:latest
    init: true
    user: "${UID}:${GID}"
    volumes:
      - ./prometheus/:/etc/prometheus/
      - ./apps-data/.prometheus:/prometheus/data
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.listen-address=${PROMETHEUS_ADDRESS:-localhost:9090}'
      - '--storage.tsdb.retention.time=1y'
      - '--web.enable-remote-write-receiver'
    network_mode: 'host'
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.1.0-ubuntu
    init: true
    network_mode: 'host'
    volumes:
      - ./apps-data/grafana:/var/lib/grafana
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini

networks:
  cluster: